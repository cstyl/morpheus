# This workflow runs test when pushing on main and develop branches

name: unit_tests-Linux
on: [push, pull_request]

concurrency:
  group: ${ {github.event_name }}-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{github.event_name == 'pull_request'}}

jobs:
  CI:
    continue-on-error: true
    strategy:
      matrix:
        distro: ['ubuntu:latest']
        cxx: ['g++-8', 'clang++-11', 'icpc']
        cmake_build_type: ['Release', 'Debug']
        backend: ['SERIAL', 'OPENMP']
    runs-on: ${{ matrix.os }}
    steps:
      - name: Build Intel Compilers
        if: ${{ matrix.cxx == 'icpc*' }}
        run: |
          wget https://apt.repos.intel.com/intel-gpg-keys/GPG-PUB-KEY-INTEL-SW-PRODUCTS.PUB
          sudo apt-key add GPG-PUB-KEY-INTEL-SW-PRODUCTS.PUB
          rm GPG-PUB-KEY-INTEL-SW-PRODUCTS.PUB
          sudo echo "deb https://apt.repos.intel.com/oneapi all main" | sudo tee /etc/apt/sources.list.d/oneAPI.list
          sudo apt-get update

          sudo apt-get install intel-basekit
          source /opt/intel/oneapi/setvars.sh
          printenv >> $GITHUB_ENV

      - name: Checkout Kokkos-v3.5.00
        uses: actions/checkout@v3
        with:
          repository: kokkos/kokkos
          ref: 3.5.00
          path: kokkos

      - name: set_default_options
        run: |
          echo "kokkos_omp=Off" >> $GITHUB_ENV
          echo "debug_mode=Off" >> $GITHUB_ENV

      - name: maybe_enable_openmp_backend
        if: ${{ matrix.backend == 'OPENMP' }}
        run: echo "kokkos_omp=On" >> $GITHUB_ENV
      
      - name: maybe_enable_aggressive_vectorization
        if: ${{ matrix.cmake_build_type == 'Debug' }}
        run: echo "debug_mode=On" >> $GITHUB_ENV

      - name: Install Kokkos
        working-directory: kokkos
        run: |
          mkdir build
          cd build

          cmake .. -DCMAKE_CXX_COMPILER=${{ matrix.cxx }} \
                   -DCMAKE_INSTALL_PREFIX=/usr/kokkos-install \
                   -DCMAKE_BUILD_TYPE=${{ matrix.cmake_build_type }} \
                   -DKokkos_ENABLE_OPENMP=${{ env.kokkos_omp }}  \
                   -DKokkos_ENABLE_SERIAL=On \
                   -DKokkos_ARCH_NATIVE=On \
                   -DKokkos_CXX_STANDARD=17 \
                   -DKokkos_ENABLE_COMPILER_WARNINGS=On \
                   -DKokkos_ENABLE_AGGRESSIVE_VECTORIZATION=${{ env.debug_mode }}\
                   -DKokkos_ENABLE_TESTS=Off \
                   -DKokkos_ENABLE_EXAMPLES=Off

          sudo cmake --build . --target install --parallel 2
